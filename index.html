<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Finanzas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@0.395.0/dist/lucide.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Clases para las vistas (login, app) */
        .vista {
            display: none; /* Oculto por defecto */
        }
        
        #loading-view.activa,
        #login-view.activa,
        #register-view.activa {
            display: flex; /* Usar flex para centrar estas vistas */
        }
        #main-app-view.activa {
            display: block; /* Usar block para la app principal */
        }

        /* Estilos para el modal */
        .modal {
            display: none; /* Oculto por defecto */
        }
        .modal.activa {
            display: flex; /* Mostrar como flex para centrar */
        }

        /* Estilo para el contenedor del gráfico */
        #chart-container {
            position: relative;
            height: 300px; /* Altura fija para el gráfico */
            width: 100%;
            max-width: 300px; /* Ancho máximo */
            margin: 0 auto; /* Centrar el gráfico */
        }

        /* Estilos para el chat de IA */
        #ai-chat-window {
            scroll-behavior: smooth;
        }
        .chat-message {
            padding: 0.75rem;
            border-radius: 0.5rem;
            max-width: 85%;
            line-height: 1.5;
        }
        .bot-message {
            background-color: #f3f4f6; /* gray-100 */
            color: #374151; /* gray-700 */
            align-self: flex-start;
        }
        .user-message {
            background-color: #e0e7ff; /* indigo-50 */
            color: #3730a3; /* indigo-900 */
            align-self: flex-end;
            margin-left: auto;
        }
        
        /* >>>>>>>>>>>>>>>>> CÓDIGO DE FONDO <<<<<<<<<<<<<<<<< */
        
        #login-view,
        #register-view {
            background-color: #f3f4f6 !important; /* gray-100 */
            position: relative !important; 
            overflow: hidden; 
        }
        
        #login-view::before,
        #register-view::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; 
            
            background-image: url('business-man-analysing-market-report-with-business-analytics-dashboard-virtual-screen.jpg');
            
            background-size: cover;
            background-position: center;
            
            filter: blur(8px); 
            -webkit-filter: blur(8px);
            
            background-color: rgba(0,0,0,0.35); 
        }
        
        #login-view > div,
        #register-view > div {
            z-index: 10;
            position: relative;
        }
        
        #login-view p, #register-view p {
            color: white !important; 
            text-shadow: 1px 1px 3px rgba(0,0,0,0.6); 
        }
        #login-view a, #register-view a {
            color: #c7d2fe !important; /* indigo-200 */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
            
            &:hover {
                color: #a5b4fc !important; /* indigo-300 */
            }
        }
    </style>
</head>
<body class="h-full font-sans antialiased">

    <div id="app-container" class="min-h-full">

        <div id="loading-view" class="vista activa items-center justify-center min-h-screen bg-gray-100">
            <div class="text-center">
                <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg font-medium text-gray-700">Cargando aplicación...</p>
                <p class="mt-1 text-sm text-gray-500">Conectando con Firebase...</p>
            </div>
        </div>

        <div id="login-view" class="vista items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-md">

                <h1 class="text-4xl font-bold text-white text-center mb-8" style="text-shadow: 2px 2px 6px rgba(0,0,0,0.6);">
                    Gestor de Finanzas
                </h1>

                <div class="bg-white p-8 rounded-lg shadow-xl border border-gray-200">
                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Iniciar Sesión</h2>
                    
                    <form id="login-form" class="space-y-6">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                            <input type="email" id="login-email" name="email" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="tu@correo.com">
                        </div>
                        
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                            <input type="password" id="login-password" name="password" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="••••••••">
                        </div>
                        
                        <button type="submit"
                            class="w-full bg-indigo-600 text-white py-3 px-4 rounded-md font-semibold shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors duration-200">
                            Iniciar Sesión
                        </button>
                    </form>
                </div>
                
                <p class="text-center font-medium mt-6 p-2 bg-black/20 rounded-md">
                    ¿No tienes cuenta? 
                    <a href="#" id="show-register-link" class="font-bold underline">
                        Regístrate
                    </a>
                </p>
            </div>
        </div>

        <div id="register-view" class="vista items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-md">

                <h1 class="text-4xl font-bold text-white text-center mb-8" style="text-shadow: 2px 2px 6px rgba(0,0,0,0.6);">
                    Gestor de Finanzas
                </h1>

                <div class="bg-white p-8 rounded-lg shadow-xl border border-gray-200">
                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Crear Cuenta</h2>
                    
                    <form id="register-form" class="space-y-6">
                        <div>
                            <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                            <input type="email" id="register-email" name="email" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="tu@correo.com">
                        </div>
                        
                        <div>
                            <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                            <input type="password" id="register-password" name="password" required minlength="6"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Mínimo 6 caracteres">
                        </div>
                        
                        <button type="submit"
                            class="w-full bg-indigo-600 text-white py-3 px-4 rounded-md font-semibold shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors duration-200">
                            Registrarse
                        </button>
                    </form>
                </div>
                
                <p class="text-center font-medium mt-6 p-2 bg-black/20 rounded-md">
                    ¿Ya tienes cuenta? 
                    <a href="#" id="show-login-link" class="font-bold underline">
                        Inicia Sesión
                    </a>
                </p>
            </div>
        </div>

        <div id="main-app-view" class="vista">
            <header class="bg-indigo-800 shadow-md sticky top-0 z-10">
                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <h1 class="text-xl font-bold text-white">
                            Gestor de Finanzas
                        </h1>
                        <div class="flex items-center space-x-4">
                            <span id="user-email-display" class="text-sm text-indigo-100 hidden sm:block"></span>
                            
                            <button id="logout-button" 
                                class="text-sm font-medium text-indigo-100 hover:text-white hover:bg-indigo-700 px-3 py-2 rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-white">
                                Cerrar Sesión
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
                
                <section id="summary-section" class="mb-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4" id="summary-title">Resumen del Mes</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <h3 class="text-sm font-medium text-gray-500">Gasto Total del Mes</h3>
                            <p id="total-month-spending" class="text-3xl font-bold text-indigo-600 mt-2">$ 0,00</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <h3 class="text-sm font-medium text-gray-500">Total Gastos Necesarios</h3>
                            <p id="total-necessary-spending" class="text-3xl font-bold text-gray-800 mt-2">$ 0,00</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <h3 class="text-sm font-medium text-gray-500">Total Gastos Innecesarios</h3>
                            <p id="total-unnecessary-spending" class="text-3xl font-bold text-red-600 mt-2">$ 0,00</p>
                        </div>
                    </div>
                </section>

                <section id="add-expense-section" class="mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Registrar Nuevo Gasto</h2>
                        <form id="add-expense-form" class="space-y-4">
                            <div>
                                <label for="expense-description" class="block text-sm font-medium text-gray-700">Descripción del Gasto</label>
                                <input type="text" id="expense-description" required
                                    class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="Ej: Materiales de estudio">
                            </div>
                            <div>
                                <label for="expense-amount" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                                <input type="text" id="expense-amount" inputmode="numeric" required
                                    class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="0">
                            </div>
                            <div class="flex items-center">
                                <input id="expense-necessary" type="checkbox"
                                    class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="expense-necessary" class="ml-2 block text-sm text-gray-800">
                                    ¿Es un gasto necesario? <span class="text-gray-500">(Ej: Alquiler, Comida, Transporte)</span>
                                </label>
                            </div>
                            <button type="submit"
                                class="w-full bg-indigo-600 text-white py-3 px-4 rounded-md font-semibold shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors duration-200">
                                Guardar Gasto
                            </button>
                        </form>
                    </div>
                </section>

                <section id="expenses-history-section" class="mb-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Historial de Gastos</h2>
                    <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                        <ul id="expenses-list" class="divide-y divide-gray-200">
                            <li id="no-expenses-message" class="p-6 text-center text-gray-500">
                                No has registrado ningún gasto este mes.
                            </li>
                        </ul>
                    </div>
                </section>

                <section id="goals-section" class="mb-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Metas de Ahorro</h2>
                    
                    <div id="goals-list" class="space-y-4 mb-4">
                        <li id="no-goals-message" class_stub="p-6 text-center text-gray-500 bg-white rounded-lg shadow border border-gray-200">
                            No has añadido ninguna meta de ahorro.
                        </li>
                    </div>
                    
                    <button id="show-add-goal-modal-button"
                        class="w-full bg-white text-indigo-600 py-3 px-4 rounded-md font-semibold shadow-lg border border-indigo-600 hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors duration-200">
                        Añadir nueva meta
                    </button>
                </section>

                <section id="analysis-section" class="mt-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Análisis de Gastos</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <div id="chart-container">
                            <canvas id="expense-chart"></canvas>
                        </div>
                    </div>
                </section>

            </main>
        </div>

    </div> 
    
    <button id="ai-bubble-button" title="Asistente de IA"
        class="fixed bottom-6 right-6 bg-indigo-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center hover:bg-indigo-700 transition-transform transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 z-30 hidden">
        <img src="https://cdn-icons-png.flaticon.com/512/1698/1698535.png" alt="AI Robot Logo" class="w-10 h-10 object-contain">
    </button>

    <div id="error-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-6 rounded-lg shadow-xl border-t-4 border-red-600">
            <h3 id="error-title" class="text-xl font-bold text-red-700 mb-4">Error</h3>
            <p id="error-message" class="text-gray-700 mb-6">Ha ocurrido un error inesperado.</p>
            <button id="close-error-modal"
                class="w-full bg-red-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                Cerrar
            </button>
        </div>
    </div>

    <div id="add-goal-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-6 rounded-lg shadow-xl">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Nueva Meta de Ahorro</h3>
            <form id="add-goal-form" class="space-y-4">
                <div>
                    <label for="goal-name" class="block text-sm font-medium text-gray-700">Nombre de la Meta</label>
                    <input type="text" id="goal-name" required
                        class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="Ej: Viaje de Graduación">
                </div>
                <div>
                    <label for="goal-target" class="block text-sm font-medium text-gray-700">Monto Objetivo ($)</label>
                    <input type="text" id="goal-target" inputmode="numeric" required
                        class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="2.000.000">
                </div>
                <div>
                    <label for="goal-current" class="block text-sm font-medium text-gray-700">Ahorrado Actualmente ($)</label>
                    <input type="text" id="goal-current" inputmode="numeric" required
                        class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="500.000">
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" id="cancel-add-goal"
                        class="w-full bg-gray-100 text-gray-700 py-2 px-4 rounded-md font-semibold border border-gray-300 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md font-semibold shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Crear Meta
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-to-goal-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-6 rounded-lg shadow-xl">
            <h3 class="text-xl font-bold text-gray-800 mb-2">Abonar a Meta</h3>
            <p id="add-to-goal-name" class="text-gray-600 mb-6">Abonando a: Viaje de Graduación</p>
            <form id="add-to-goal-form" class="space-y-4">
                <div>
                    <label for="add-to-goal-amount" class="block text-sm font-medium text-gray-700">Monto a Abonar ($)</label>
                    <input type="text" id="add-to-goal-amount" inputmode="numeric" required
                        class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="0">
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" id="cancel-add-to-goal"
                        class="w-full bg-gray-100 text-gray-700 py-2 px-4 rounded-md font-semibold border border-gray-300 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md font-semibold shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Abonar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="ai-assistant-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-6 rounded-lg shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-indigo-700 flex items-center">
                    <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>
                    Asistente de IA
                </h3>
                <button id="close-ai-modal" class="text-gray-400 hover:text-gray-600 text-3xl font-light leading-none pt-0 pb-1 px-2">
                    &times;
                </button>
            </div>
            
            <div id="ai-chat-window" class="h-64 w-full bg-gray-50 rounded-md border border-gray-200 p-4 overflow-y-auto mb-4 flex flex-col space-y-3">
                <div class="chat-message bot-message">
                    <p class="text-sm">¡Hola! Soy tu asistente de finanzas. ¿En qué puedo ayudarte hoy? Puedes seleccionar una de las preguntas frecuentes.</p>
                </div>
            </div>
            
            <div id="ai-suggested-questions" class="space-y-2">
                <button class="w-full text-left p-3 bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-sm"
                        data-question-key="faq-necesario" 
                        data-question-text="¿Qué es un 'gasto necesario'?">
                    ¿Qué es un "gasto necesario"?
                </button>
                <button class="w-full text-left p-3 bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-sm"
                        data-question-key="faq-ahorrar" 
                        data-question-text="¿Cuál es el mejor consejo para ahorrar?">
                    ¿Cuál es el mejor consejo para ahorrar?
                </button>
                <button class="w-full text-left p-3 bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-sm"
                        data-question-key="faq-metas" 
                        data-question-text="¿Por qué son importantes las metas?">
                    ¿Por qué son importantes las metas?
                </button>
            </div>
        </div>
    </div>
    
    <div id="confirm-delete-modal" class="modal fixed inset-0 bg-black bg-opacity-75 z-50 items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-6 rounded-lg shadow-xl">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Confirmar Eliminación</h3>
            <p id="confirm-message" class="text-gray-700 mb-6">¿Estás seguro?</p>
            <div class="flex gap-4 pt-4">
                <button type="button" id="cancel-delete-btn"
                    class="w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-md font-semibold border border-gray-300 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                    Cancelar
                </button>
                <button type="button" id="confirm-delete-btn"
                    class="w-full bg-red-600 text-white py-2 px-4 rounded-md font-semibold shadow-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                    Eliminar
                </button>
            </div>
        </div>
    </div>


    <script src="config.js"></script>

    <script type="module">
        // Importar las funciones necesarias
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            onSnapshot, 
            doc, 
            deleteDoc, 
            writeBatch,
            runTransaction,
            Timestamp,
            orderBy // Importamos orderBy
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // --- 1. CONFIGURACIÓN INICIAL ---
        
        // --- CAMBIO: La constante 'firebaseConfig' fue eliminada de aquí ---
        // --- Se carga automáticamente desde 'config.js' ---
        
        // ----------------------------------------------------

        // No estamos usando el token inicial del entorno Canvas
        const appId = 'app-de-finanzas-estudiantil'; // Usamos tu Project ID

        // Inicializar Firebase
        let app;
        let auth;
        let db;
        
        // Variables globales de estado
        let currentUserId = null;
        let expensesUnsubscribe = () => {};
        let goalsUnsubscribe = () => {};
        let expenseChartInstance = null;

        // Mapeo de meses para el título
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
        ];

        // --- 2. ELEMENTOS DEL DOM ---
        const views = {
            loading: document.getElementById('loading-view'),
            login: document.getElementById('login-view'),
            register: document.getElementById('register-view'),
            mainApp: document.getElementById('main-app-view'),
        };

        const authForms = {
            login: document.getElementById('login-form'),
            register: document.getElementById('register-form'),
        };

        const appElements = {
            userEmailDisplay: document.getElementById('user-email-display'),
            logoutButton: document.getElementById('logout-button'),
            summaryTitle: document.getElementById('summary-title'),
            totalMonthSpending: document.getElementById('total-month-spending'),
            totalNecessarySpending: document.getElementById('total-necessary-spending'),
            totalUnnecessarySpending: document.getElementById('total-unnecessary-spending'),
            addExpenseForm: document.getElementById('add-expense-form'),
            expenseDescription: document.getElementById('expense-description'),
            expenseAmount: document.getElementById('expense-amount'),
            expenseNecessary: document.getElementById('expense-necessary'),
            expensesList: document.getElementById('expenses-list'),
            noExpensesMessage: document.getElementById('no-expenses-message'),
            goalsList: document.getElementById('goals-list'),
            noGoalsMessage: document.getElementById('no-goals-message'),
            showAddGoalModalButton: document.getElementById('show-add-goal-modal-button'),
            expenseChartCanvas: document.getElementById('expense-chart'),
            aiBubbleButton: document.getElementById('ai-bubble-button'),
        };

        const links = {
            showRegister: document.getElementById('show-register-link'),
            showLogin: document.getElementById('show-login-link'),
        };

        const errorModal = {
            modal: document.getElementById('error-modal'),
            title: document.getElementById('error-title'),
            message: document.getElementById('error-message'),
            closeButton: document.getElementById('close-error-modal'),
        };
        
        const addGoalModal = {
            modal: document.getElementById('add-goal-modal'),
            form: document.getElementById('add-goal-form'),
            name: document.getElementById('goal-name'),
            target: document.getElementById('goal-target'),
            current: document.getElementById('goal-current'),
            cancelButton: document.getElementById('cancel-add-goal'),
        };

        const addToGoalModal = {
            modal: document.getElementById('add-to-goal-modal'),
            form: document.getElementById('add-to-goal-form'),
            nameDisplay: document.getElementById('add-to-goal-name'),
            amount: document.getElementById('add-to-goal-amount'),
            cancelButton: document.getElementById('cancel-add-to-goal'),
            currentGoalId: null,
        };
        
        const aiAssistantModal = {
            modal: document.getElementById('ai-assistant-modal'),
            closeButton: document.getElementById('close-ai-modal'),
            chatWindow: document.getElementById('ai-chat-window'),
            suggestedQuestions: document.getElementById('ai-suggested-questions'),
        };

        let confirmDeleteModal = {
            modal: document.getElementById('confirm-delete-modal'),
            message: document.getElementById('confirm-message'),
            confirmButton: document.getElementById('confirm-delete-btn'),
            cancelButton: document.getElementById('cancel-delete-btn')
        };


        // --- 3. FUNCIONES DE UTILIDAD ---

        function showView(viewName) {
            console.log(`Mostrando vista: ${viewName}`);
            Object.values(views).forEach(view => view.classList.remove('activa'));
            if (views[viewName]) {
                views[viewName].classList.add('activa');
            }
        }

        function showError(title, message) {
            console.error(title, message);
            errorModal.title.textContent = title;
            errorModal.message.textContent = message;
            errorModal.modal.classList.add('activa');
        }

        function hideError() {
            errorModal.modal.classList.remove('activa');
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP',
                minimumFractionDigits: 0
            }).format(amount).replace('CLP', '$');
        }
        
        function toggleAddGoalModal(show) {
            if (show) {
                addGoalModal.form.reset();
                addGoalModal.modal.classList.add('activa');
            } else {
                addGoalModal.modal.classList.remove('activa');
            }
        }
        
        function toggleAddToGoalModal(show, goalId = null, goalName = '') {
            if (show) {
                addToGoalModal.form.reset();
                addToGoalModal.currentGoalId = goalId;
                addToGoalModal.nameDisplay.textContent = `Abonando a: ${goalName}`;
                addToGoalModal.modal.classList.add('activa');
            } else {
                addToGoalModal.modal.classList.remove('activa');
                addToGoalModal.currentGoalId = null;
            }
        }

        function toggleAiModal(show) {
            if (show) {
                resetAiChat();
                aiAssistantModal.modal.classList.add('activa');
                lucide.createIcons(); 
            } else {
                aiAssistantModal.modal.classList.remove('activa');
            }
        }
        
        function toggleConfirmModal(show, message = '', onConfirmCallback = () => {}) {
            if (show) {
                confirmDeleteModal.message.textContent = message;
                
                // Clonar y reemplazar botones para limpiar listeners viejos (muy importante)
                const newConfirmButton = confirmDeleteModal.confirmButton.cloneNode(true);
                confirmDeleteModal.confirmButton.parentNode.replaceChild(newConfirmButton, confirmDeleteModal.confirmButton);
                confirmDeleteModal.confirmButton = newConfirmButton;
                
                const newCancelButton = confirmDeleteModal.cancelButton.cloneNode(true);
                confirmDeleteModal.cancelButton.parentNode.replaceChild(newCancelButton, confirmDeleteModal.cancelButton);
                confirmDeleteModal.cancelButton = newCancelButton;

                // Asignar nuevas acciones
                confirmDeleteModal.confirmButton.addEventListener('click', () => {
                    onConfirmCallback(); // Ejecutar la acción de borrado
                    toggleConfirmModal(false); // Ocultar modal
                });
                
                confirmDeleteModal.cancelButton.addEventListener('click', () => {
                    toggleConfirmModal(false);
                });
                
                confirmDeleteModal.modal.classList.add('activa');
            } else {
                confirmDeleteModal.modal.classList.remove('activa');
            }
        }

        function cleanNumberString(formattedString) {
            return formattedString.replace(/\./g, ''); 
        }

        function formatNumberInput(e) {
            let input = e.target;
            let value = input.value;
            
            let cursorPosition = input.selectionStart;
            let originalLength = value.length;

            let numericValue = value.replace(/\D/g, '');
            
            if (numericValue === '') {
                input.value = '';
                return;
            }

            let formattedValue = new Intl.NumberFormat('es-CL').format(numericValue);
            
            input.value = formattedValue;
            
            let newLength = formattedValue.length;
            let newCursorPosition = cursorPosition + (newLength - originalLength);
            
            input.setSelectionRange(newCursorPosition, newCursorPosition);
        }

        // --- LÓGICA DEL CHAT DE IA SIMULADO ---
        
        function addMessageToChat(message, type) {
            const chatWindow = aiAssistantModal.chatWindow;
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', type === 'user' ? 'user-message' : 'bot-message');
            
            const p = document.createElement('p');
            p.className = 'text-sm';
            p.textContent = message;
            messageDiv.appendChild(p);
            
            chatWindow.appendChild(messageDiv);
            
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function getBotResponse(questionKey) {
            let response = "Lo siento, no entiendo esa pregunta. Intenta con otra de las opciones.";
            switch (questionKey) {
                case 'faq-necesario':
                    response = "Un 'gasto necesario' es un costo fijo o esencial que no puedes evitar fácilmente, como el alquiler, las cuentas de servicios (luz, agua), la comida básica, el transporte para ir a estudiar o los materiales de estudio obligatorios.";
                    break;
                case 'faq-ahorrar':
                    response = "¡El mejor consejo es la consistencia! Intenta seguir la regla 50/30/20: 50% de tus ingresos para gastos necesarios, 30% para gastos innecesarios (deseados) y un 20% directo a tus ahorros. ¡Incluso si ahorras menos, lo importante es crear el hábito!";
                    break;
                case 'faq-metas':
                    response = "Las metas de ahorro son clave porque te dan un objetivo claro y motivación. Es mucho más fácil ahorrar $20.000 para un 'Viaje de Graduación' (algo que te emociona) que simplemente 'ahorrar por ahorrar'. ¡Te ayudan a mantenerte enfocado!";
                    break;
            }
            return response;
        }

        function handleFaqClick(e) {
            const button = e.target.closest('button.w-full');
            if (!button) return;

            const questionKey = button.dataset.questionKey;
            const questionText = button.dataset.questionText;
            
            addMessageToChat(questionText, 'user');
            
            setTimeout(() => {
                const botResponse = getBotResponse(questionKey);
                addMessageToChat(botResponse, 'bot');
            }, 600);
        }

        function resetAiChat() {
            const chatWindow = aiAssistantModal.chatWindow;
            chatWindow.innerHTML = `
                <div class="chat-message bot-message">
                    <p class="text-sm">¡Hola! Soy tu asistente de finanzas. ¿En qué puedo ayudarte hoy? Puedes seleccionar una de las preguntas frecuentes.</p>
                </div>
            `;
        }


        // --- 4. LÓGICA DE FIREBASE (AUTENTICACIÓN) ---

        async function handleRegister(e) {
            e.preventDefault();
            const email = authForms.register['register-email'].value;
            const password = authForms.register['register-password'].value;

            try {
                showView('loading');
                await createUserWithEmailAndPassword(auth, email, password);
                console.log('Usuario registrado exitosamente.');
            } catch (error) {
                console.error('Error en registro:', error);
                showView('register');
                showError('Error de Registro', getFirebaseAuthErrorMessage(error));
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = authForms.login['login-email'].value;
            const password = authForms.login['login-password'].value;

            try {
                showView('loading');
                await signInWithEmailAndPassword(auth, email, password);
                console.log('Usuario inició sesión exitosamente.');
            } catch (error) {
                console.error('Error en inicio de sesión:', error);
                showView('login');
                showError('Error de Inicio de Sesión', getFirebaseAuthErrorMessage(error));
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                console.log('Usuario cerró sesión.');
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
                showError('Error', 'No se pudo cerrar la sesión.');
            }
        }

        function setupAuthObserver() {
            onAuthStateChanged(auth, (user) => {
                expensesUnsubscribe();
                goalsUnsubscribe();
                if (expenseChartInstance) {
                    expenseChartInstance.destroy();
                    expenseChartInstance = null;
                }
                
                if (user) {
                    currentUserId = user.uid;
                    
                    if (!db) {
                        db = getFirestore(app);
                        console.log("Firestore inicializado.");
                    }
                    
                    appElements.userEmailDisplay.textContent = user.email;
                    
                    const now = new Date();
                    appElements.summaryTitle.textContent = `Resumen de ${monthNames[now.getMonth()]} de ${now.getFullYear()}`;
                    
                    setupExpensesListener(user.uid);
                    setupGoalsListener(user.uid);
                    
                    showView('mainApp');
                    appElements.aiBubbleButton.classList.remove('hidden');
                } else {
                    currentUserId = null;
                    appElements.userEmailDisplay.textContent = '';
                    
                    appElements.expensesList.innerHTML = '';
                    appElements.goalsList.innerHTML = '';
                    
                    showView('login');
                    appElements.aiBubbleButton.classList.add('hidden');
                }
                lucide.createIcons();
            });
        }
        
        function getFirebaseAuthErrorMessage(error) {
            switch (error.code) {
                case 'auth/invalid-email':
                    return 'El formato del correo electrónico no es válido.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    return 'Correo electrónico o contraseña incorrectos.';
                case 'auth/email-already-in-use':
                    return 'Este correo electrónico ya está registrado.';
                case 'auth/weak-password':
                    return 'La contraseña es demasiado débil (debe tener al menos 6 caracteres).';
                case 'auth/api-key-not-valid':
                case 'auth/app-deleted':
                    return 'Error crítico de configuración. Revisa tu API Key de Firebase.';
                default:
                    return `Ocurrió un error inesperado: ${error.message}`;
            }
        }


        // --- 5. LÓGICA DE FIRESTORE (BASE DE DATOS) ---

        async function handleAddExpense(e) {
            e.preventDefault();
            if (!currentUserId || !db) return;

            const description = appElements.expenseDescription.value;
            const amount = parseFloat(cleanNumberString(appElements.expenseAmount.value));
            const isNecessary = appElements.expenseNecessary.checked;
            
            if (!description || isNaN(amount) || amount <= 0) {
                showError('Datos Inválidos', 'Por favor, ingresa una descripción y un monto válido.');
                return;
            }

            try {
                const docRef = await addDoc(collection(db, "users", currentUserId, "expenses"), {
                    description: description,
                    amount: amount,
                    isNecessary: isNecessary,
                    createdAt: Timestamp.now()
                });
                console.log("Gasto añadido con ID: ", docRef.id);
                appElements.addExpenseForm.reset();
            } catch (error) {
                console.error("Error al añadir gasto: ", error);
                showError('Error de Base de Datos', 'No se pudo guardar el gasto.');
            }
        }

        function setupExpensesListener(userId) {
            if (!userId || !db) return;

            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);

            const expensesRef = collection(db, "users", userId, "expenses");
            const q = query(expensesRef, 
                where("createdAt", ">=", Timestamp.fromDate(startOfMonth)),
                where("createdAt", "<=", Timestamp.fromDate(endOfMonth)),
                orderBy("createdAt", "desc")
            );

            expensesUnsubscribe = onSnapshot(q, (snapshot) => {
                const expenses = [];
                snapshot.forEach(doc => {
                    expenses.push({ id: doc.id, ...doc.data() });
                });
                renderExpenses(expenses);
            }, (error) => {
                console.error("Error al obtener gastos: ", error);
                showError('Error de Conexión', 'No se pudieron cargar los gastos.');
            });
        }
        
        function renderExpenses(expenses) {
            appElements.expensesList.innerHTML = '';
            
            let total = 0;
            let necessary = 0;
            let unnecessary = 0;

            if (expenses.length === 0) {
                appElements.expensesList.appendChild(appElements.noExpensesMessage);
            } else {
                expenses.forEach(expense => {
                    total += expense.amount;
                    if (expense.isNecessary) {
                        necessary += expense.amount;
                    } else {
                        unnecessary += expense.amount;
                    }
                    
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between p-4 sm:p-6 hover:bg-gray-50';
                    
                    li.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-800">${expense.description}</p>
                            <span class="text-sm ${expense.isNecessary ? 'text-gray-500' : 'text-red-600'}">
                                ${expense.isNecessary ? 'Necesario' : 'Innecesario'}
                            </span>
                        </div>
                        <div class="text-right flex items-center space-x-2">
                            <p class="font-semibold ${expense.isNecessary ? 'text-gray-900' : 'text-red-600'}">
                                - ${formatCurrency(expense.amount)}
                            </p>
                            <button data-id="${expense.id}" data-description="${expense.description}" class="delete-expense-btn text-gray-400 hover:text-red-600" title="Eliminar gasto">
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
                                </svg>
                            </button>
                        </div>
                    `;
                    appElements.expensesList.appendChild(li);
                });
            }
            
            appElements.totalMonthSpending.textContent = formatCurrency(total);
            appElements.totalNecessarySpending.textContent = formatCurrency(necessary);
            appElements.totalUnnecessarySpending.textContent = formatCurrency(unnecessary);
            
            updateExpenseChart(necessary, unnecessary);
        }

        async function handleDeleteExpense(e) {
            const deleteButton = e.target.closest('.delete-expense-btn');
            if (deleteButton && currentUserId && db) {
                const expenseId = deleteButton.dataset.id;
                const expenseDescription = deleteButton.dataset.description; 
                
                const deleteAction = async () => {
                    try {
                        await deleteDoc(doc(db, "users", currentUserId, "expenses", expenseId));
                        console.log('Gasto eliminado');
                    } catch (error) {
                        console.error('Error al eliminar gasto: ', error);
                        showError('Error', 'No se pudo eliminar el gasto.');
                    }
                };
                
                toggleConfirmModal(
                    true, 
                    `¿Estás seguro de que quieres eliminar el gasto: "${expenseDescription}"?`, 
                    deleteAction
                );
            }
        }
        
        async function handleAddGoal(e) {
            e.preventDefault();
            if (!currentUserId || !db) return;

            const name = addGoalModal.name.value;
            const targetAmount = parseFloat(cleanNumberString(addGoalModal.target.value));
            const currentAmount = parseFloat(cleanNumberString(addGoalModal.current.value));

            if (!name || isNaN(targetAmount) || targetAmount <= 0 || isNaN(currentAmount) || currentAmount < 0) {
                showError('Datos Inválidos', 'Por favor, ingresa un nombre y montos válidos.');
                return;
            }
            
            if (currentAmount > targetAmount) {
                showError('Datos Inválidos', 'El monto ahorrado no puede ser mayor que el monto objetivo.');
                return;
            }

            try {
                await addDoc(collection(db, "users", currentUserId, "goals"), {
                    name: name,
                    targetAmount: targetAmount,
                    currentAmount: currentAmount,
                    createdAt: Timestamp.now()
                });
                console.log("Meta añadida");
                toggleAddGoalModal(false);
            } catch (error) {
                console.error("Error al añadir meta: ", error);
                showError('Error de Base de Datos', 'No se pudo guardar la meta.');
            }
        }
        
        function setupGoalsListener(userId) {
            if (!userId || !db) return;

            const goalsRef = collection(db, "users", userId, "goals");
            const q = query(goalsRef, orderBy("createdAt", "desc"));

            goalsUnsubscribe = onSnapshot(q, (snapshot) => {
                const goals = [];
                snapshot.forEach(doc => {
                    goals.push({ id: doc.id, ...doc.data() });
                });
                renderGoals(goals);
            }, (error) => {
                console.error("Error al obtener metas: ", error);
                showError('Error de Conexión', 'No se pudieron cargar las metas de ahorro.');
            });
        }
        
        function renderGoals(goals) {
            appElements.goalsList.innerHTML = '';

            if (goals.length === 0) {
                const noGoalsMsg = appElements.noGoalsMessage.cloneNode(true);
                noGoalsMsg.id = '';
                noGoalsMsg.className = 'p-6 text-center text-gray-500 bg-white rounded-lg shadow border border-gray-200';
                appElements.goalsList.appendChild(noGoalsMsg);
            } else {
                goals.forEach(goal => {
                    const percentage = goal.targetAmount > 0 ? (goal.currentAmount / goal.targetAmount) * 100 : 0;
                    
                    const li = document.createElement('li');
                    li.className = 'bg-white p-6 rounded-lg shadow-lg border border-gray-200';
                    
                    li.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-lg font-semibold text-gray-800">${goal.name} 🎓</span>
                            <button data-id="${goal.id}" data-name="${goal.name}" class="delete-goal-btn text-gray-400 hover:text-red-600" title="Eliminar meta">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
                                </svg>
                            </button>
                        </div>
                        <div class="flex justify-between items-baseline mb-3">
                            <span class="text-sm font-medium text-indigo-600">
                                Ahorrado: ${formatCurrency(goal.currentAmount)}
                            </span>
                            <span class="text-sm text-gray-500">
                                Meta: ${formatCurrency(goal.targetAmount)}
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                            <div class="bg-indigo-500 h-2.5 rounded-full" style="width: ${percentage.toFixed(0)}%"></div>
                        </div>
                        <div class="text-right text-sm text-gray-500 mb-4">
                            ${percentage.toFixed(0)}% completado
                        </div>
                        
                        <button data-id="${goal.id}" data-name="${goal.name}"
                            class="add-to-goal-btn w-full bg-indigo-50 text-indigo-700 py-2 px-4 rounded-md font-semibold border border-indigo-200 hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            Abonar a esta meta
                        </button>
                    `;
                    appElements.goalsList.appendChild(li);
                });
            }
        }
        
        async function handleGoalClick(e) {
            if (!currentUserId || !db) return;

            const addButton = e.target.closest('.add-to-goal-btn');
            if (addButton) {
                const goalId = addButton.dataset.id;
                const goalName = addButton.dataset.name;
                toggleAddToGoalModal(true, goalId, goalName);
                return;
            }

            const deleteButton = e.target.closest('.delete-goal-btn');
            if (deleteButton) {
                const goalId = deleteButton.dataset.id;
                const goalName = deleteButton.dataset.name; 
                
                const deleteAction = async () => {
                    try {
                        await deleteDoc(doc(db, "users", currentUserId, "goals", goalId));
                        console.log('Meta eliminada');
                    } catch (error) {
                        console.error('Error al eliminar meta: ', error);
                        showError('Error', 'No se pudo eliminar la meta.');
                    }
                };
                
                toggleConfirmModal(
                    true, 
                    `¿Estás seguro de que quieres eliminar la meta: "${goalName}"?`, 
                    deleteAction
                );
            }
        }
        
        async function handleAddToGoal(e) {
            e.preventDefault();
            const goalId = addToGoalModal.currentGoalId;
            const amountToAdd = parseFloat(cleanNumberString(addToGoalModal.amount.value));

            if (!goalId || isNaN(amountToAdd) || amountToAdd <= 0 || !db) {
                showError('Monto Inválido', 'Ingresa un monto válido para abonar.');
                return;
            }
            
            const goalRef = doc(db, "users", currentUserId, "goals", goalId);

            try {
                await runTransaction(db, async (transaction) => {
                    const goalDoc = await transaction.get(goalRef);
                    if (!goalDoc.exists()) {
                        throw new Error("¡La meta ya no existe!");
                    }

                    const data = goalDoc.data();
                    let newAmount = data.currentAmount + amountToAdd;
                    
                    if (newAmount > data.targetAmount) {
                         newAmount = data.targetAmount;
                         console.log('Se alcanzó la meta. El abono se ajustó.');
                    }

                    transaction.update(goalRef, { currentAmount: newAmount });
                });

                console.log("¡Abono exitoso!");
                toggleAddToGoalModal(false);
            } catch (error) {
                console.error("Error en la transacción de abono: ", error);
                showError('Error', `No se pudo realizar el abono: ${error.message}`);
            }
        }

        // --- LÓGICA DEL GRÁFICO ---

        function updateExpenseChart(necessary, unnecessary) {
            if (!appElements.expenseChartCanvas) return;
            
            const ctx = appElements.expenseChartCanvas.getContext('2d');
            const data = {
                labels: ['Gastos Necesarios', 'Gastos Innecesarios'],
                datasets: [{
                    label: 'Distribución de Gastos',
                    data: [necessary, unnecessary],
                    backgroundColor: [
                        'rgb(79, 70, 229)', /* Color indigo-600 */
                        'rgb(220, 38, 38)' /* Color red-600 */
                    ],
                    borderColor: 'rgb(255, 255, 255)',
                    borderWidth: 3,
                    hoverOffset: 4
                }]
            };

            if (expenseChartInstance) {
                expenseChartInstance.data.datasets[0].data = [necessary, unnecessary];
                expenseChartInstance.update();
            } else {
                expenseChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 14,
                                        family: 'Inter, sans-serif'
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += formatCurrency(context.parsed);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }


        // --- 6. PUNTO DE ENTRADA (MAIN) ---

        function main() {
            try {
                // Inicializar servicios de Firebase
                // 'firebaseConfig' es cargado desde config.js
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                console.log("Firebase App y Auth inicializados.");

                // --- Añadir Event Listeners ---

                // Navegación Auth
                links.showRegister.addEventListener('click', (e) => { e.preventDefault(); showView('register'); });
                links.showLogin.addEventListener('click', (e) => { e.preventDefault(); showView('login'); });

                // Formularios Auth
                authForms.login.addEventListener('submit', handleLogin);
                authForms.register.addEventListener('submit', handleRegister);

                // App Principal
                appElements.logoutButton.addEventListener('click', handleLogout);
                appElements.addExpenseForm.addEventListener('submit', handleAddExpense);
                
                // Modales
                errorModal.closeButton.addEventListener('click', hideError);
                appElements.showAddGoalModalButton.addEventListener('click', () => toggleAddGoalModal(true));
                addGoalModal.cancelButton.addEventListener('click', () => toggleAddGoalModal(false));
                addGoalModal.form.addEventListener('submit', handleAddGoal);
                
                addToGoalModal.cancelButton.addEventListener('click', () => toggleAddToGoalModal(false));
                addToGoalModal.form.addEventListener('submit', handleAddToGoal);

                // Listeners para la burbuja y modal de IA
                appElements.aiBubbleButton.addEventListener('click', () => toggleAiModal(true));
                aiAssistantModal.closeButton.addEventListener('click', () => toggleAiModal(false));
                
                // Listener para las preguntas frecuentes (delegación)
                aiAssistantModal.suggestedQuestions.addEventListener('click', handleFaqClick);

                // Delegación de eventos para listas dinámicas
                appElements.expensesList.addEventListener('click', handleDeleteExpense);
                appElements.goalsList.addEventListener('click', handleGoalClick);

                // Listeners para formateo de números
                appElements.expenseAmount.addEventListener('input', formatNumberInput);
                addGoalModal.target.addEventListener('input', formatNumberInput);
                addGoalModal.current.addEventListener('input', formatNumberInput);
                addToGoalModal.amount.addEventListener('input', formatNumberInput);

                // Iniciar el observador de autenticación
                setupAuthObserver();
                
            } catch (error) {
                console.error("Error crítico al inicializar Firebase:", error);
                showView('loading');
                alert(`Error Crítico: No se pudo inicializar Firebase. Revisa tu objeto 'firebaseConfig'.\n\n${error.message}`);
            }
        }

        // --- 7. EJECUCIÓN ---
        
        document.addEventListener('DOMContentLoaded', main);
        
    </script>
</body>
</html>